<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>GeoFS ATC Screen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .label {
      font-family: Inter, "Noto Sans TC", Arial, sans-serif;
      font-size:12px;
      padding:2px 6px;
      border-radius:6px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
      white-space: nowrap;
      margin-left: 6px;
    }
    .legend {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">GeoFS ATC — connected: <span id="connCount">0</span></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* === CONFIG (部署後請更新 WS_URL) === */
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
/* ===================================== */

// --- Tile Layers ---
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
});

const googleStreet = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  attribution: 'Map data © Google'
});

const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  attribution: 'Imagery © Google'
});

// 初始化地圖 (預設 Google 街道)
const map = L.map('map', {
  worldCopyJump: true,
  maxZoom: 19,
  minZoom: 2,
  maxBounds: [[-85,-180],[85,180]],
  maxBoundsViscosity: 1.0,
  layers: [googleStreet]
}).setView([20, 0], 2);

// 圖層控制
L.control.layers({
  "OpenStreetMap": osmLayer,
  "Google Streets": googleStreet,
  "Google Satellite": googleSat
}).addTo(map);

// --- Aircrafts ---
const aircrafts = new Map(); // id -> { marker, polyline, path, lastSeen, data }
const PLANE_IMG = "https://i.ibb.co/SXn3xXPP/image.png";
const MAX_TRACK_POINTS = 50; // 軌跡最多點數

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

// 飛機圖示 + Label
function makeDivIcon(data) {
  const imgW = 32, imgH = 32;
  const labelW = 150, labelH = 50;
  const iconW = imgW + labelW, iconH = Math.max(imgH, labelH);
  return L.divIcon({
    html: `
      <div style="display:flex;align-items:center;width:${iconW}px;height:${iconH}px;">
        <img src="${PLANE_IMG}" width="${imgW}" height="${imgH}"
             style="display:block;transform:rotate(${data.heading||0}deg);" />
        <div class="label">
          <strong>${escapeHtml(data.callsign || 'UNK')}</strong>
          <div style="font-size:11px;">
            ${escapeHtml(data.type||'??')}
            · ${Math.round(data.alt||0)}ft
            · ${typeof data.speed === 'number' ? Math.round(data.speed) : '---'}kt
          </div>
          <div style="font-size:11px;">
            ${escapeHtml(data.flightNo||'')} ${escapeHtml(data.departure||'')}→${escapeHtml(data.arrival||'')}
          </div>
        </div>
      </div>
    `,
    className: '',
    iconSize: [iconW, iconH],
    iconAnchor: [imgW/2, iconH/2]
  });
}


// 更新/新增飛機
function updateAircraft(id, data) {
  const key = id;
  const latlng = [data.lat, data.lon];

  if (aircrafts.has(key)) {
    const obj = aircrafts.get(key);
    obj.marker.setLatLng(latlng);
    obj.marker.setIcon(makeDivIcon(data));
    obj.lastSeen = Date.now();
    obj.data = data;

    // 更新路徑
    obj.path.push(latlng);
    if (obj.path.length > MAX_TRACK_POINTS) obj.path.shift();
    obj.polyline.setLatLngs(obj.path);

  } else {
    const marker = L.marker(latlng, { icon: makeDivIcon(data) }).addTo(map);
    const polyline = L.polyline([latlng], {
      color: "orange",
      weight: 2,
      opacity: 0.7
    }).addTo(map);

    aircrafts.set(key, { marker, polyline, path:[latlng], lastSeen: Date.now(), data });
  }
  document.getElementById('connCount').innerText = aircrafts.size;
}

// 移除飛機
function removeAircraft(id) {
  if (aircrafts.has(id)) {
    const obj = aircrafts.get(id);
    map.removeLayer(obj.marker);
    map.removeLayer(obj.polyline);
    aircrafts.delete(id);
    document.getElementById('connCount').innerText = aircrafts.size;
  }
}

// 移除過期飛機
function removeStaleAircrafts(timeoutMs=30000) {
  const now = Date.now();
  for (const [k,v] of aircrafts.entries()) {
    if (now - v.lastSeen > timeoutMs) {
      map.removeLayer(v.marker);
      map.removeLayer(v.polyline);
      aircrafts.delete(k);
    }
  }
  document.getElementById('connCount').innerText = aircrafts.size;
}
setInterval(() => removeStaleAircrafts(30000), 5000);

// --- WebSocket ---
let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', ()=> {
    ws.send(JSON.stringify({ type: 'hello', role: 'atc' }));
  });
  ws.addEventListener('message', (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'aircraft_update') {
        (Array.isArray(msg.payload) ? msg.payload : [msg.payload])
          .forEach(a => updateAircraft(a.id, a));
      } else if (msg.type === 'aircraft_snapshot') {
        msg.payload.forEach(a => updateAircraft(a.id, a));
      } else if (msg.type === 'aircraft_remove') {
        msg.payload.forEach(id => removeAircraft(id));
      }
    } catch(e) {}
  });
  ws.addEventListener('close', ()=> setTimeout(connectWS, 2000));
  ws.addEventListener('error', ()=> ws.close());
}
connectWS();
</script>
</body>
</html>
