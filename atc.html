<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>GeoFS ATC Screen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .legend {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">GeoFS ATC — connected: <span id="connCount">0</span></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';

const map = L.map('map', {
  worldCopyJump: true,
  maxZoom: 8,
  minZoom: 2
}).setView([20, 0], 2);

L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  attribution: 'Map data © Google'
}).addTo(map);

const aircrafts = new Map();

function makeImageIcon(data) {
  return L.icon({
    iconUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA4RpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo2NjFmMDIxMC00NDhjLTY3NDQtYjFkOC1mMTEyZTRmY2I5ZWEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NjAyQzIyOTZDRDc4MTFFOUEwMUFGMzk4Mjg5NDVBQ0YiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjAyQzIyOTVDRDc4MTFFOUEwMUFGMzk4Mjg5NDVBQ0YiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NGU1NjlmYzktMTRlYS02YTQ1LTg3OTMtZmU1MDFlNWExN2I5IiBzdFJlZjpkb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6ZTc3YzE0ZDEtOTM3NC03ZjQ4LThkMjUtODRjY2JmZWNkZGEyIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+di3hcAAAA49JREFUeNrsWEtoE0EYzuwr7yZN26StUC21B7VUQtGTikWKQg+eevGkXnuQggdPnrxJ8ajgQaTQS5FSvJWCHhQtqK2W0iqVJA19JDXPzSbZ5/jPuoutVPNoaApm4M+yO/P/+8383//NZBHG2HKUGmU5Yq0BqAGoAei/A8SQH4RQNb7EiQXjzDjQFDDZMK1qQKQFR2YqclyYuk53DYyewBYc1BSxF+DRWJWWWVvzWir6dqXn4n2xUjAQ8zegKhoWhe0iQlRzS/fQKEVbHanomyd8/MtidvujWg8OabHVF/FsbHEDsmenrW6XImXpZOR1CvrUA3HITAFcrAYnygGqj4c0NQEJGVgpSlMlJzzzk7gQj/Cp1M6NDb4VgDL6JBDZ7YHUBFh728nhIdbu68OaSpfMF9ZYqzPQqYgZL6TsAs25mGTk1Sr4hjSl+EOR+AyA/PdKQTHBJKKxlSlC4CiYaALyHeu/OeY7PniHsXndh1nmWJPV9Mb8TPj9wzECykyN2+HrvXrYYPRFolja1XrqSlN7sIdQxQSkqFIuWS8xhHfzUj6RIwtmAsqkN949L2TCUeAA3o97wBnL/n0luYZ1371X3UhcuZDkM1sfJovZ9QgZblZZHsp1FgYpno5zI4jmAr8qDf8hzGZEVTPeZiEuTR0D/YzVw4L+RBSRDyOKVkwHIy3crntkRMOapmTzqbXZ+NfpaXhE5AKbpDY1yU74BGYzHf9SqiZSxNpbBnovP3jKOfye6KfHjxKhuWfwPFeG3pEYkjFWIGW/R6nhAZm1YFi5Uo/kQsILpVuAVXPBUpDSDUMsoR5KTSahCxtW5QKYqojZ5EFUulbHD0VTxZymyaIqZtNHAZCsqXIGthBBFtP1BUQ4RMipyrmEqhQzIr8pHHR2TJVAiF8T2UhB4c9D6fshbQ63/+wgH/+sQP829KWBY1LFym2WfbkHNONU0Nlx5sYtV1vfCOcMnGBtHieiGASkFiUhvplPfZ8DCRiHcaFKQFV7QLMCmOHWnmt3ac7t0rVMlTFRcdjxrXbO1W33dt+mWQcKz4/fg/GJw+EQLC3StRPhQnY9xu8shZCFwuRe74RtvIzzUE04JG4tT76EMw9j83RdQoi2CMlv8+TsA+k6zXCuVim/s7S5NDGxj2LXnkO7eOQAc5og3YEgy8cWzFUvEjAQU6n0kG+p4fchVIsgtfyjWJOZocYXtBLtpwADAJHg4JCaUqqzAAAAAElFTkSuQmCC',      // ←這裡換成你的PNG路徑
    iconSize: [24, 24],        // 依你的圖檔實際尺寸調整
    iconAnchor: [12, 12]       // 設成中心
  });
}

function updateAircraft(id, data) {
  const key = id;
  const latlng = [data.lat, data.lon];
  if (aircrafts.has(key)) {
    const obj = aircrafts.get(key);
    obj.marker.setLatLng(latlng);
    obj.marker.setIcon(makeImageIcon(data));
    obj.lastSeen = Date.now();
    obj.data = data;
  } else {
    const marker = L.marker(latlng, {
      icon: makeImageIcon(data)
    }).addTo(map);
    aircrafts.set(key, { marker, lastSeen: Date.now(), data });
  }
  document.getElementById('connCount').innerText = aircrafts.size;
}

function removeAircraft(id) {
  if (aircrafts.has(id)) {
    map.removeLayer(aircrafts.get(id).marker);
    aircrafts.delete(id);
    document.getElementById('connCount').innerText = aircrafts.size;
  }
}

function removeStaleAircrafts(timeoutMs=30000) {
  const now = Date.now();
  for (const [k,v] of aircrafts.entries()) {
    if (now - v.lastSeen > timeoutMs) {
      map.removeLayer(v.marker);
      aircrafts.delete(k);
    }
  }
  document.getElementById('connCount').innerText = aircrafts.size;
}

setInterval(() => removeStaleAircrafts(30000), 5000);

/* WebSocket connection */
let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', ()=> {
    ws.send(JSON.stringify({ type: 'hello', role: 'atc' }));
  });
  ws.addEventListener('message', (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'aircraft_update') {
        if (Array.isArray(msg.payload)) {
          msg.payload.forEach(a => updateAircraft(a.id, a));
        } else {
          updateAircraft(msg.payload.id, msg.payload);
        }
      } else if (msg.type === 'aircraft_snapshot') {
        msg.payload.forEach(a => updateAircraft(a.id, a));
      } else if (msg.type === 'aircraft_remove') {
        msg.payload.forEach(id => removeAircraft(id));
      }
    } catch(e) { }
  });
  ws.addEventListener('close', ()=> {
    setTimeout(connectWS, 2000);
  });
  ws.addEventListener('error', (e)=> {
    ws.close();
  });
}

connectWS();

</script>
</body>
</html>

