// 在 WebSocket 連接部分添加請求歷史數據的功能
function connectWS() {
  ws = new WebSocket(WS_URL);
  
  ws.addEventListener('open', () => {
    ws.send(JSON.stringify({type: 'hello', role: 'atc'}));
    
    // 🔥 新增：主動請求所有在線飛機的歷史軌跡
    setTimeout(() => {
      ws.send(JSON.stringify({
        type: 'request_all_history',
        payload: {
          maxPoints: 10000, // 請求更多歷史點
          timeRange: 3600000 // 請求過去1小時的數據
        }
      }));
    }, 1000);
  });
  
  ws.addEventListener('message', ev => {
    try {
      const m = JSON.parse(ev.data);
      
      if (m.type === 'aircraft_update') {
        (Array.isArray(m.payload) ? m.payload : [m.payload]).forEach(a => 
          updateAircraft(a.id, a, m.trackPoint)
        );
      }
      else if (m.type === 'aircraft_snapshot') {
        m.payload.forEach(a => {
          updateAircraft(a.id, a);
          // 🔥 對每架飛機請求歷史軌跡
          ws.send(JSON.stringify({
            type: 'request_aircraft_history',
            payload: {
              aircraftId: a.id,
              maxPoints: 5000,
              timeRange: 7200000 // 2小時
            }
          }));
        });
      }
      // 處理歷史軌跡（放寬驗證條件）
      else if (m.type === 'aircraft_track_history') {
        const { aircraftId, tracks } = m.payload;
        createHistoricalTrackImproved(aircraftId, tracks);
      }
      else if (m.type === 'aircraft_track_clear') {
        const { aircraftId } = m.payload;
        clearAircraftTrack(aircraftId);
      }
      else if (m.type === 'aircraft_remove') {
        m.payload.forEach(id => removeAircraft(id));
      }
    } catch (e) {
      console.warn('Message parse error:', e);
    }
  });
  
  ws.addEventListener('close', () => setTimeout(connectWS, 2000));
  ws.addEventListener('error', () => ws.close());
}

// 🔥 改進的歷史軌跡創建函數 - 放寬驗證條件
function createHistoricalTrackImproved(aircraftId, tracks) {
  if (!aircrafts.has(aircraftId)) {
    const lastTrack = tracks[tracks.length - 1];
    if (lastTrack) {
      const dummyData = {
        callsign: aircraftId,
        type: lastTrack.type || '??',
        lat: lastTrack.lat,
        lon: lastTrack.lon,
        alt: lastTrack.alt,
        heading: lastTrack.heading || 0,
        speed: lastTrack.speed || 0,
        flightNo: lastTrack.flightNo || '',
        departure: lastTrack.departure || '',
        arrival: lastTrack.arrival || ''
      };
      const marker = L.marker([lastTrack.lat, lastTrack.lon], {icon: makeDivIcon(dummyData)}).addTo(map);
      marker.on('click', () => showAircraftPanel(dummyData));
      aircrafts.set(aircraftId, {
        marker,
        segments: [],
        path: [],
        lastSeen: Date.now(),
        data: dummyData
      });
    }
  }
  
  const obj = aircrafts.get(aircraftId);
  if (!obj) return;
  
  // 清除現有軌跡
  obj.segments.forEach(s => map.removeLayer(s));
  obj.segments = [];
  obj.path = [];
  
  if (tracks.length > 1) {
    console.log(`Processing ${tracks.length} historical track points for ${aircraftId}`);
    
    // 🔥 改進：更智能的軌跡分段處理
    let currentSegment = [tracks[0]];
    let allSegments = [];
    
    for (let i = 1; i < tracks.length; i++) {
      const prev = tracks[i-1];
      const curr = tracks[i];
      const distance = calculateDistance(prev.lat, prev.lon, curr.lat, curr.lon);
      const timeDiff = curr.timestamp && prev.timestamp ? 
        Math.abs(curr.timestamp - prev.timestamp) : 0;
      
      // 🔥 放寬條件：允許更大的距離和時間間隔
      const isNewSegment = distance > 200 || timeDiff > 600000; // 200km 或 10分鐘
      
      if (isNewSegment && currentSegment.length > 1) {
        // 結束當前段，開始新段
        allSegments.push([...currentSegment]);
        currentSegment = [curr];
      } else {
        currentSegment.push(curr);
      }
    }
    
    // 添加最後一段
    if (currentSegment.length > 1) {
      allSegments.push(currentSegment);
    }
    
    // 繪製所有軌跡段
    let totalPoints = 0;
    allSegments.forEach((segment, segIndex) => {
      // 🔥 特殊處理：起飛階段使用特殊顏色
      const isInitialSegment = segIndex === 0;
      
      for (let i = 1; i < segment.length; i++) {
        const prev = segment[i-1];
        const curr = segment[i];
        const prevLatLng = [prev.lat, prev.lon];
        const currLatLng = [curr.lat, curr.lon];
        
        let color = getAltitudeColor(curr.alt);
        
        // 🔥 起飛段特殊標記
        if (isInitialSegment && (curr.alt || 0) < 1000) {
          color = '#ff6b35'; // 橙紅色標示起飛階段
        }
        
        const seg = L.polyline([prevLatLng, currLatLng], {
          color: color,
          weight: isInitialSegment ? 3 : 2, // 起飛段加粗
          opacity: 0.9,
          dashArray: isInitialSegment ? '5,5' : null // 起飛段虛線
        }).addTo(map);
        
        const tooltipText = isInitialSegment ? 
          `起飛階段: ${Math.round(curr.alt || 0)} ft` : 
          `${Math.round(curr.alt || 0)} ft`;
        
        seg.bindTooltip(tooltipText, {permanent: false});
        obj.segments.push(seg);
        totalPoints++;
        
        if (obj.segments.length > MAX_TRACK_POINTS) {
          map.removeLayer(obj.segments.shift());
        }
      }
    });
    
    // 更新路徑數組
    obj.path = tracks.map(t => [t.lat, t.lon]);
    
    console.log(`✅ Restored ${totalPoints} track segments in ${allSegments.length} parts for ${aircraftId}`);
    
    // 🔥 如果有起飛數據，在地圖上標記起飛點
    if (tracks.length > 0 && (tracks[0].alt || 0) < 500) {
      const takeoffPoint = tracks[0];
      const takeoffMarker = L.circleMarker([takeoffPoint.lat, takeoffPoint.lon], {
        radius: 8,
        fillColor: '#ff6b35',
        color: '#ffffff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map);
      
      takeoffMarker.bindTooltip(`🛫 起飛點: ${aircraftId}`, {permanent: false});
      
      // 將起飛標記也加入管理（可選）
      if (!obj.takeoffMarker) {
        obj.takeoffMarker = takeoffMarker;
      }
    }
  }
}

// 🔥 新增：手動請求特定飛機的歷史數據
function requestAircraftHistory(aircraftId) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'request_aircraft_history',
      payload: {
        aircraftId: aircraftId,
        maxPoints: 10000,
        timeRange: 7200000, // 2小時
        includeGroundTrack: true // 請求包含地面滑行數據
      }
    }));
    console.log(`Requested full history for ${aircraftId}`);
  }
}

// 🔥 在飛機面板中添加請求歷史按鈕
function showAircraftPanel(data) {
  let p = document.getElementById('aircraftPanel');
  if (!p) {
    p = document.createElement('div');
    p.id = 'aircraftPanel';
    Object.assign(p.style, {
      position: 'absolute', top: '50px', right: '10px', width: '280px',
      background: 'rgba(0,0,0,0.85)',
      color: '#fff',
      borderRadius: '8px', padding: '10px',
      boxShadow: '0 2px 6px rgba(0,0,0,0.7)',
      fontSize: '13px', zIndex: 9999
    });
    document.body.appendChild(p);
  }
  
  const c = getAltitudeColor(data.alt);
  p.innerHTML = `
    <h3 style="margin:0 0 5px;border-left:3px solid ${c};padding-left:8px;">${escapeHtml(data.callsign || 'UNK')}</h3>
    <div><strong>Flight:</strong> ${escapeHtml(data.flightNo || '')}</div>
    <div><strong>Route:</strong> ${escapeHtml(data.departure || '')} → ${escapeHtml(data.arrival || '')}</div>
    <div><strong>Aircraft:</strong> ${escapeHtml(data.type || '')}</div>
    <div><strong>Altitude:</strong> <span style="color:${c};font-weight:bold;">${Math.round(data.alt || 0)} ft</span></div>
    <div><strong>Speed:</strong> ${formatSpeed(data.speed)} kt</div>
    <div><strong>Takeoff (UTC):</strong> ${escapeHtml(data.takeoffTime || '—')}</div>
    <div style="margin-top:8px;">
      <button onclick="requestAircraftHistory('${data.callsign || data.id}')" 
              style="padding:4px 8px;margin-right:5px;background:#007acc;color:white;border:none;border-radius:4px;cursor:pointer;">
        請求完整軌跡
      </button>
      <button onclick="document.getElementById('aircraftPanel').remove()" 
              style="padding:4px 8px;background:#666;color:white;border:none;border-radius:4px;cursor:pointer;">
        關閉
      </button>
    </div>`;
}
