<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>GeoFS ATC Screen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .label {
      font-family: Inter, "Noto Sans TC", Arial, sans-serif;
      font-size:12px;
      padding:2px 6px;
      border-radius:6px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
      white-space: nowrap;
      margin-left: 6px;
    }
    .legend {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,0.9);
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend">GeoFS ATC — connected: <span id="connCount">0</span></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* === CONFIG (部署後請更新 WS_URL) === */
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
// 如果你把 server 與此頁面分開部署，請改為 `wss://your-render-service.onrender.com/ws`
/* ===================================== */

const map = L.map('map', {
  worldCopyJump: true,
  maxZoom: 19,
  minZoom: 2
}).setView([20, 0], 2);

L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  attribution: 'Map data © Google'
}).addTo(map);

const aircrafts = new Map(); // id -> { marker, lastSeen, data }

// 設定你的 PNG 路徑
const PLANE_IMG = "https://i.ibb.co/SXn3xXPP/image.png"; // 請把 plane.png 放在同目錄或改成你的路徑

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

// 使用 divIcon，左側 PNG，右側 label
function makeDivIcon(data) {
  // 設定圖示大小
  const imgW = 32, imgH = 32;
  const labelW = 90, labelH = 32;
  const iconW = imgW + labelW, iconH = Math.max(imgH, labelH);
  // anchor 設在飛機圖中心
  return L.divIcon({
    html: `
      <div style="display:flex;align-items:center;width:${iconW}px;height:${iconH}px;">
        <img src="${PLANE_IMG}" width="${imgW}" height="${imgH}"
             style="display:block;transform:rotate(${data.heading||0}deg);" />
        <div class="label">
          <strong>${escapeHtml(data.callsign || 'UNK')}</strong>
          <div style="font-size:11px;">
            ${escapeHtml(data.type||'??')} · ${Math.round(data.alt||0)}ft
          </div>
        </div>
      </div>
    `,
    className: '',
    iconSize: [iconW, iconH],
    iconAnchor: [imgW/2, iconH/2] // 飛機中心
  });
}

function updateAircraft(id, data) {
  const key = id;
  const latlng = [data.lat, data.lon];
  if (aircrafts.has(key)) {
    const obj = aircrafts.get(key);
    obj.marker.setLatLng(latlng);
    obj.marker.setIcon(makeDivIcon(data));
    obj.lastSeen = Date.now();
    obj.data = data;
  } else {
    const marker = L.marker(latlng, {
      icon: makeDivIcon(data)
    }).addTo(map);
    aircrafts.set(key, { marker, lastSeen: Date.now(), data });
  }
  document.getElementById('connCount').innerText = aircrafts.size;
}

function removeAircraft(id) {
  if (aircrafts.has(id)) {
    map.removeLayer(aircrafts.get(id).marker);
    aircrafts.delete(id);
    document.getElementById('connCount').innerText = aircrafts.size;
  }
}

function removeStaleAircrafts(timeoutMs=30000) {
  const now = Date.now();
  for (const [k,v] of aircrafts.entries()) {
    if (now - v.lastSeen > timeoutMs) {
      map.removeLayer(v.marker);
      aircrafts.delete(k);
    }
  }
  document.getElementById('connCount').innerText = aircrafts.size;
}

setInterval(() => removeStaleAircrafts(30000), 5000);

/* WebSocket connection */
let ws;
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', ()=> {
    ws.send(JSON.stringify({ type: 'hello', role: 'atc' }));
  });
  ws.addEventListener('message', (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'aircraft_update') {
        if (Array.isArray(msg.payload)) {
          msg.payload.forEach(a => updateAircraft(a.id, a));
        } else {
          updateAircraft(msg.payload.id, msg.payload);
        }
      } else if (msg.type === 'aircraft_snapshot') {
        msg.payload.forEach(a => updateAircraft(a.id, a));
      } else if (msg.type === 'aircraft_remove') {
        msg.payload.forEach(id => removeAircraft(id));
      }
    } catch(e) { }
  });
  ws.addEventListener('close', ()=> {
    setTimeout(connectWS, 2000);
  });
  ws.addEventListener('error', (e)=> {
    ws.close();
  });
}

connectWS();

</script>
</body>
</html>

